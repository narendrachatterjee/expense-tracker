<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Collection Form</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    #form-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #camera-container {
      position: relative;
      margin-bottom: 16px;
    }
    #camera-container video {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    #camera-controls button {
      flex: 1;
      padding: 10px;
      background-color: #28a745;
    }
    #camera-controls button.cancel {
      background-color: #6c757d;
    }
    #photo-preview {
      display: none;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    #status {
      margin-top: 16px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 4px;
    }
    #auth-button {
      margin-bottom: 20px;
    }
  </style>
  <!-- Load the new Google Identity Services library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Load the Google API client library (for Drive and Sheets APIs) -->
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div id="form-container">
    <h2>Data Collection Form</h2>
    <!-- Sign In/Out button -->
    <button id="auth-button">Sign In with Google</button>
    
    <!-- Data form; initially hidden until the user signs in -->
    <form id="dataForm" style="display: none;">
      <label for="name">Full Name</label>
      <input type="text" id="name" name="name" placeholder="Your full name" required />

      <label for="email">Email Address</label>
      <input type="email" id="email" name="email" placeholder="Your email" required />

      <label for="notes">Additional Notes</label>
      <textarea id="notes" name="notes" rows="3" placeholder="Your notes"></textarea>
      
      <!-- Button to open the camera -->
      <button type="button" id="open-camera">Take Photo</button>

      <!-- Camera container -->
      <div id="camera-container" style="display: none;">
        <video id="video" autoplay></video>
        <div id="camera-controls">
          <button type="button" id="capture">Capture</button>
          <button type="button" id="cancel-camera" class="cancel">Cancel</button>
        </div>
      </div>

      <!-- Photo preview and retake option -->
      <img id="photo-preview" alt="Photo Preview" />
      <button type="button" id="retake-photo" style="display: none;">Retake Photo</button>
      
      <!-- Submit button -->
      <button type="submit" id="submit-form">Submit</button>
    </form>

    <div id="status"></div>
  </div>

  <script>
    /***************************************
     * Configuration – Replace placeholders:
     ***************************************/
     const API_KEY = "AIzaSyB0PCnlFKH57YGaE0am8h5dtK6pnZXOURU";
    const CLIENT_ID = "423668944032-mrhstv88ge0jds6i1l2hcrl4bifmfaun.apps.googleusercontent.com";
    const DISCOVERY_DOCS = [
      "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
      "https://sheets.googleapis.com/$discovery/rest?version=v4"
    ];
    const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets";
    const SHEET_ID = "1TwUrxtMxyapuwcF9YQnSguRDli7PmCQObwhQjdoGWaA";
    const FOLDER_ID = "1LRM9kD-261k62JiBGFqKrxSnrgduClCh";

    /***************************************
     * DOM element references
     ***************************************/
    const authButton = document.getElementById("auth-button");
    const formEl = document.getElementById("dataForm");
    const statusEl = document.getElementById("status");
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const notesEl = document.getElementById("notes");
    const openCameraBtn = document.getElementById("open-camera");
    const cameraContainer = document.getElementById("camera-container");
    const videoEl = document.getElementById("video");
    const captureBtn = document.getElementById("capture");
    const cancelCameraBtn = document.getElementById("cancel-camera");
    const photoPreviewEl = document.getElementById("photo-preview");
    const retakeBtn = document.getElementById("retake-photo");

    /***************************************
     * Global Variables
     ***************************************/
    let accessToken = null;
    let tokenClient = null;
    let stream = null;
    let photoBlob = null;

    /***************************************
     * Helper Functions
     ***************************************/
    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function updateSignInStatus(signedIn) {
      if (signedIn) {
        authButton.textContent = "Sign Out from Google";
        formEl.style.display = "block";
      } else {
        authButton.textContent = "Sign In with Google";
        formEl.style.display = "none";
      }
    }

    /***************************************
     * Initialize gapi client for Drive and Sheets APIs
     ***************************************/
    function initGapiClient() {
      gapi.load("client", async () => {
        await gapi.client.setApiKey(API_KEY);
        await gapi.client.load("drive", "v3");
        await gapi.client.load("sheets", "v4");
      });
    }

    /***************************************
     * Window onload – Initialize both gapi and the new token client
     ***************************************/
    window.onload = () => {
      initGapiClient();
      // Initialize token client using Google Identity Services
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (response) => {
          if (response.error) {
            setStatus("Error obtaining token: " + response.error);
            return;
          }
          accessToken = response.access_token;
          updateSignInStatus(true);
        }
      });
    };

    /***************************************
     * Authentication Button Handler
     ***************************************/
    authButton.onclick = () => {
      if (!accessToken) {
        // Request an access token; force consent prompt
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        // Sign out: revoke the token
        google.accounts.oauth2.revoke(accessToken, () => {
          accessToken = null;
          updateSignInStatus(false);
          setStatus("Signed out.");
        });
      }
    };

    /***************************************
     * Camera Functions – Request back camera only
     ***************************************/
    openCameraBtn.onclick = async function () {
      cameraContainer.style.display = "block";
      // Request only the back camera (environment facing)
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: { exact: "environment" } } 
        });
        videoEl.srcObject = stream;
      } catch (err) {
        setStatus("Back camera access failed: " + err.message);
      }
    };

    captureBtn.onclick = function () {
      const canvas = document.createElement("canvas");
      canvas.width = videoEl.videoWidth;
      canvas.height = videoEl.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
      // Display photo preview
      photoPreviewEl.src = canvas.toDataURL("image/jpeg");
      photoPreviewEl.style.display = "block";
      // Convert to Blob for upload
      canvas.toBlob(function (blob) {
        photoBlob = blob;
      }, "image/jpeg");
      stopCamera();
      retakeBtn.style.display = "block";
    };

    cancelCameraBtn.onclick = function () {
      stopCamera();
    };

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
        stream = null;
      }
      cameraContainer.style.display = "none";
    }

    retakeBtn.onclick = function () {
      photoPreviewEl.style.display = "none";
      photoPreviewEl.src = "";
      photoBlob = null;
      retakeBtn.style.display = "none";
      openCameraBtn.click();
    };

    /***************************************
     * Form Submission Handler with Async/Await
     ***************************************/
    formEl.onsubmit = async function (e) {
      e.preventDefault();
      if (!accessToken) {
        setStatus("Please sign in with Google first.");
        return;
      }
      if (!photoBlob) {
        setStatus("Please take a photo before submitting.");
        return;
      }
      setStatus("Uploading photo to Google Drive...");
      try {
        // Wait until the image is uploaded to Drive
        const fileData = await uploadToDrive();
        setStatus("Updating Google Sheet...");
        await updateSheet(fileData);
        setStatus("Submission successful!");
        formEl.reset();
        photoPreviewEl.style.display = "none";
        photoPreviewEl.src = "";
        photoBlob = null;
        retakeBtn.style.display = "none";
      } catch (error) {
        setStatus("Error: " + error.message);
      }
    };

    /***************************************
     * API Interaction Functions
     ***************************************/
    // Upload photo to Google Drive via multipart POST call.
    async function uploadToDrive() {
      const fileName = "photo_" + nameEl.value + "_" + Date.now() + ".jpg";
      const metadata = {
        name: fileName,
        mimeType: "image/jpeg",
        parents: [FOLDER_ID]
      };
      const formData = new FormData();
      formData.append(
        "metadata",
        new Blob([JSON.stringify(metadata)], { type: "application/json" })
      );
      formData.append("file", photoBlob);
      const response = await fetch(
        "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
        {
          method: "POST",
          headers: new Headers({ Authorization: "Bearer " + accessToken }),
          body: formData
        }
      );
      const result = await response.json();
      return { fileId: result.id, fileName: fileName };
    }

    // Update Google Sheet by appending a new row with the form data and the photo link.
    async function updateSheet(fileData) {
      const values = [[
        nameEl.value,
        emailEl.value,
        notesEl.value,
        fileData.fileName,
        "https://drive.google.com/file/d/" + fileData.fileId + "/view"
      ]];
      const body = { values: values };
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: "Sheet1!A:E",
        valueInputOption: "USER_ENTERED",
        resource: body
      });
    }
  </script>
</body>
</html>
